\section{Likelihood formalism}
\label{sec:likelihoods}

The observables measured in events containing tau lepton pairs 
do not provide sufficient information to fully determine the tau--pair mass, $M_{\tau\tau}$.
Depending on whether the two tau leptons decay hadronically or leptonically, 
the kinematics of the tau--pair decays depends upon $4$--$6$ parameters:
the $4$ angles $\theta_{1}$, $\overline{\phi_{1}}$ and $\theta_{2}$, $\overline{\phi_{2}}$
plus $0$--$2$ masses $\mnus^{1}$ and $\mnus^{2}$,
as described in section~\ref{sec:tau_decay_kinematics}.
This contrasts with only $2$ observables which constrain the momenta of the neutrinos produced in the tau decays:
the two components \METx and \METy of the reconstructed missing transverse momentum, \MET.
%The two \MET components are reconstructed with non--negligible experimental reconstruction,
%amounting to typically $\sigma$\METx$ = \sigma$\METy$ \sim 15$~GeV in the 2011/2012 data--taking period~\cite{DP_12_003,DP_12_013}.

In the SVfit algorithm the fact that the tau decay kinematics is underconstrained by measured observables is handled via a likelihood approach.
In the literature,
the term {\em Dynamical Likelihood Methods} (DLM) has been introduced for the application of likelihood methods 
to problems of reconstructing kinematic quantities on an event--by--event basis~\cite{Kondo:1988,Kondo:1991}.
This is the approach taken by SVfit.
$M_{\tau\tau}$ values are reconstructed by combining the measured observables \METx and \METy with a probability model,
which in the present version of SVfit includes terms for tau decay kinematics and for the \MET resolution~\footnote{
  We foresee to include tau decay vertex information provided by tracking detectors in future versions of the SVfit algorithm.
  The idea of using decay vertex information in the $M_{\tau\tau}$ reconstruction is actually what SVfit owes its name to.
}.
The model makes a prediction for the probability density $p(\vec{x} \vert \vec{y}, \vec{a})$ 
to observe the values $\vec{x} = (\METx, \METy)$ measured in an event,
given that the unknown parameters specifying the kinematics of the tau--pair decay have values
$\vec{a} = (\theta_{1}, \overline{\phi_{1}}, \theta_{2}, \overline{\phi_{2}}, \mnus^{1}, \mnus^{2})$~\footnote{
  In case of hadronic tau decays the $\mnus$ are constants of value zero in our notation.
}
and the four--momenta of the visible decay products are equal to the observed $\vec{y} = (p^{vis}_{1}, p^{vis}_{2})$.

Two different methods exist for determining the best estimate for $\vec{a}$, 
given the measured values $\vec{x}$ and $\vec{y}$ plus a probability model $p(\vec{x} \vert \vec{y}, \vec{a})$.

In the first method, called {\em marginalization}, a probability 
\begin{equation}\label{eq:mtautau}
P(M_{\tau\tau}) = \int \delta \left( M_{\tau\tau} - M_{\tau\tau}(\vec{y}, \vec{a} \right) p(\vec{x} \vert \vec{y}, \vec{a}) d\vec{a}
\end{equation}
is computed.
The integration of the probability densities is performed numerically using the VEGAS~\cite{VEGAS} algorithm.
In order to find the best estimate for $M_{\tau\tau}$,
a series of $P(M_{\tau\tau})$ values is
computed for an ascending series of mass hypotheses $M_{\tau\tau}$~\footnote{
  The probabilities $P(M_{\tau\tau})$ are computed in steps of $M_{\tau\tau}$.
  The steps are defined by the recursive relation $\delta M_{i+1} = 1.025 \times \delta M_{i}$, 
  where $\delta M_{0} = 2.5~\GeV$, within the range $M_{\tau\tau} \in [5, 2000]$~\GeV.
}.
The best estimate $\hat{M}_{\tau\tau}$ for the tau--pair mass is taken to be the value $M_{\tau\tau}^{i}$ which maximizes $P(M_{\tau\tau}^{i})$.
Lower (upper) limits on the reconstructed mass $\hat{M}_{\tau\tau}$ are determined for every event
by the $0.16$ ($0.84$) quantiles of the series of mass hypotheses $M_{\tau\tau}^{i}$
and associated probability values $P(M_{\tau\tau}^{i})$.

Alternative to finding $M_{\tau\tau}$ solutions by marginalization of the probability densities,
estimates for the tau--pair mass may be obtained via the {\em profile likelihood method}.
In the latter,
the best estimate for $M_{\tau\tau}$ is obtained by maximizing the probability density
$p(\vec{x} \vert \vec{y}, \vec{a})$ with respect to all parameters $\vec{a}$ not corresponding to measured observables:
\begin{equation*}
p(\vec{x} \vert \vec{y}, \hat{a}) = \max_{\vec{a}} p(\vec{x} \vert \vec{y}, \vec{a}).
\end{equation*}
The best estimate $\hat{M}_{\tau\tau}$ for the tau--pair mass is then taken to be $\hat{M}_{\tau\tau} = M_{\tau\tau}(\vec{y}, \hat{a})$.
Uncertainties on the reconstructed mass $\hat{M}_{\tau\tau}$ are computed by varying the parameters $\hat{a}$ 
within the region by which the negative logarithm of the probability density $p(\vec{x} \vert \vec{y}, \vec{a})$ 
increases by $0.5$ units or less with respect to the best fit value $p(\vec{x} \vert \vec{y}, \hat{a})$.

Conceptual complications in using the profile likelihood method in the context of DLM
arise from the fact that probability densities, not probabilities, need to be maximized.
The issue with probability densities is that Jacobian terms $\partial y/\partial y'$ come into existence
in case variables are reparametrized according to $\vec{y} \mapsto \vec{y}' = f(\vec{y})$.
The Jacobian terms are expected to have little effect on the final result in case the likelihood functions are well constrained by the measured observables.
This assumption is not always true when applying likelihood methods to single events, however.
In practice the Jacobian terms often do have an effect, hence introduce an undesirable element of arbitrariness.
A second issue of reconstructing kinematic quantities via maximization of likelihood functions
is that estimates of kinematic quantities may be biased.
In case the width of likelihood functions varies as function of the value of the kinematic quantity of interest,
the profile likelihood method gives preference to solutions for which the likelihood functions are narrow and peaked.
In SVfit, we reduce potential biases of this kind by making the widths of likelihood functions
independent of $M_{\tau\tau}$ via suitable reparametrization of the variables $\vec{y}$.
Additionally, we add a pseudo--Jacobian term of the form:
\begin{equation} 
\sin \theta_{1} \cdot \sin \theta_{2} \cdot \log M_{\tau\tau}
\label{eq:pseudoJacobianTerm}
\end{equation}
to the likelihood function
in case $M_{\tau\tau}$ solutions are computed via the profile likelihood method.
The pseudo--Jacobian term is purely artificial. The motivation to add this term is that phenomenologically we find it to improve the resolution.
The maximization of likelihood functions is performed numerically using the MINUIT~\cite{MINUIT} package.
The main advantage of reconstructing $M_{\tau\tau}$ via the profile likelihood method
is that MINUIT fits may be substantially less computationally extensive than the numerical integrations performed by VEGAS~\footnote{  
  Computing the $M_{\tau\tau}$ solution for a single event typically takes $1$~s ($10$~ms) 
  in case the solution is obtained via marginalization (the profile likelihood method) on a $2.27$~GHz Intel\TReg~Xeon\TReg~L5520 processor.
}.

The terms for tau decay kinematics and \MET resolution included
in the probability density $p(\vec{x} \vert \vec{y}, \vec{a})$ are described in the following sections.
We will occasionally refer to them as likelihood functions.
Two different probability models for the tau lepton decay kinematics are considered,
detailed in sections~\ref{sec:psKine} and~\ref{sec:meKine} respectively.
The likelihood term based on \MET is described in section~\ref{sec:likelihoods_met}.

\begin{figure}
\setlength{\unitlength}{1mm}
\begin{center}
\begin{picture}(150,60)(0,0)
\put(-0.5, 2){\mbox{\includegraphics*[height=58mm]
  {figures/makeSVfitToyMCplots_X1_m90_beforeVisPtCuts.pdf}}}
\put(78.0, 2){\mbox{\includegraphics*[height=58mm]
  {figures/makeSVfitToyMCplots_X2_m90_beforeVisPtCuts.pdf}}}
\end{picture}
\caption{\captiontext 
  Distributions of the visible energy fraction $X$ in 
  $\tau \rightarrow \ell\nu\nu$ (left) and $\tau \rightarrow \tau_{had}\nu$ (right) decays simulated by TAUOLA~\cite{tauola}),
  compared to the ``Phase--space'' and ``Matrix element'' models described in the text.
}
\label{fig:visEnFractionModelComparisson}
\end{center}
\end{figure} 


\subsection{Phase--space model}
\label{sec:psKine} 

The ``phase--space'' model has been introduced by an early version of the SVfit algorithm~\cite{AN-11-165}.
The probability density function for a decay into a final state
$(\theta, \overline \phi, m_{\nu\nu})$ is taken proportional to
the corresponding phase--space factor:
\begin{displaymath}
d\Gamma \propto d\Phi_n(p_1,...,p_n),
\end{displaymath}
assuming tau decay matrix elements to be constant.
$d\Phi_n$ denotes the phase--space volume for a decay into $n$ particles
$n=3$ ($n=2$) in leptonic (hadronic) tau decays.

For leptonic tau decays, we obtain the three--body phase--space formula~\cite{PDG},
which simplifies to:
\begin{equation}
\frac{d\Gamma}{d\overline{x} dm_{\nu\nu} d\overline\phi}
\propto \frac{ m_{\tau}^2-m_{\nu\nu}^2 }{2m_{\tau}} 
\mbox{ within the physically allowed region } 
0 \leq \overline{x} \leq 1 \mbox{ and } 0 \leq m_{\nu\nu} \leq m_{\tau}\sqrt{1-\overline{x}},
\label{eq:leptDecayPS}
\end{equation}
if masses of electrons and muons are neglected.

For hadronic tau decays, we obtain a uniform probability density function for the decay width:
\begin{equation}
\frac{d\Gamma}{d\overline{x}d\overline\phi} = \frac{1}{2\pi}\left(\frac{1}{1- \frac{m^2_{vis}}{m^2_{\tau}}}\right) 
\mbox{ within the physically allowed region } 
\frac{m_{vis}^{2}}/{m_{\tau}^{2}} \leq \overline{x} \leq 1.
\label{eq:hadDecayPS}
\end{equation}

Note that the phase--space model does not distinguish between helicity states of the tau lepton:
it therefore neglects spin correlations between the two taus.


\subsection{Matrix element model}
\label{sec:meKine}

Matrix elements for leptonic and hadronic tau decays exist in the literature~\cite{TauPol1,TauPol2}. 
The differential decay widths for the two helicity eigenstates
are different.
The invariance under CP implies equal amplitudes between the left--handed $\tau^-$
and right--handed $\tau^+$ ($P_{\tau}=-1$), and between the right--handed
$\tau^-$ and the left--handed $\tau^+$ ($P_{\tau}=+1$).

Even though the polarization of the tau lepton is not measurable on an event--by--event
basis, the spin of the resonance decaying to tau--pairs (either Higgs or $Z$--boson) 
implies a selection rule on the
polarization of the two tau leptons. 
Denoting by $\gamma_{\alpha\beta}$ the probability for 
the tau lepton of negative charge to be in helicity state $\alpha$ 
and the tau lepton of positive charge to be in helicity state $\beta$,
the SM predicts for Higgs boson decays:
\begin{eqnarray}\label{eq:gammaH}
\gamma_{LL} & = & \gamma_{RR} = \frac{1}{2} \nonumber \\
\gamma_{LR} & = & \gamma_{RL} = 0 
\label{eq:gammaH}
\end{eqnarray}
and for decays of $Z$--bosons:
\begin{eqnarray}
\gamma_{LL} & = & \gamma_{RR} = 0 \nonumber \\
\gamma_{LR} & = & \frac{1}{2}(1 - \langle P_{\tau}\rangle) \nonumber \\
\gamma_{RL} & = & \frac{1}{2}(1 + \langle P_{\tau}\rangle),
\label{eq:gammaZ}
\end{eqnarray}
where $\langle P_{\tau}\rangle = \frac{-2va}{a^2+v^2}$ with $v = \frac{1}{2} + 2\sin^2\theta_{W}$ and $a = -\frac{1}{2}$ at the $Z$--pole~\cite{PDG}.
Numerically, $\gamma_{LR} \approx 0.576$ and  $\gamma_{RL} \approx 0.424$,
predicting a small polarization of the taus to arise in the $Z\to\tau^{+}\tau^{-}$ decays as consequence of the chiral structure
of the SM Lagrangian.
The case $\gamma_{\alpha \beta} = \frac{1}{4} \; \forall \alpha,\beta$ corresponds to
an uniform prior on the polarizations
of the taus;
it is equivalent to assume that the intial tau leptons are
unpolarized ($P_{\tau}=0$). We will refer to this as the ``unpolarized case''.

\subsubsection{Leptonic tau decays} $\;$\\
\\
The probability density functions for the decay
$\tau^-\to \ell^- \: \bar{\nu}_{\ell} \: \nu_{\tau}$ of a tau lepton in helicity eigenstate
$P_{\tau}=\pm1$ is given by:
\begin{equation} 
\frac{d\Gamma}{d\overline{x}dm_{\nu\nu}d\overline\phi} \propto \frac{m_{\nu\nu}}{4m_{\tau}^2} [(m_{\tau}^2 +2m_{\nu\nu}^2 )(m_{\tau}^2 - m_{\nu\nu}^2) +
P_{\tau}(m_{\tau}^2(2\overline{x} -1) + m_{\nu\nu}^2)(-m_{\tau}^2+2m_{\nu\nu}^2)  ].
\label{eq:lepDecay}
\end{equation}
Eq.~\ref{eq:lepDecay} is obtained from Ref.~\cite{TauPol1} after performing a suitable transformation of variables.
The distribution $\frac{d\Gamma}{d\overline{x}dm_{\nu\nu}d\overline\phi}$ is visualized by density plots in the $(\overline{x},m_{\nu\nu})$ plane
for polarization states $P_{\tau}=+1$ and $P_{\tau}=-1$ Fig.~\ref{fig:2DCorrLep}. 
The decay width of unpolarized tau leptons is obtained by setting $P_{\tau}=0$ in Eq.~\ref{eq:lepDecay}.

\begin{figure}[htbp]
\centering
\subfigure[]{
  \includegraphics[width=0.45\linewidth]{figures/MassReconstruction/2DCorrLepMinus.pdf}
  \label{fig:2DCorrLepMinus}
}
\subfigure[]{
  \includegraphics[width=0.45\linewidth]{figures/MassReconstruction/2DCorrLepPlus.pdf}
  \label{fig:2DCorrLepPlus}
} \\
\caption{Probability density function of the visible energy fraction $\overline{x}$ and neutrino--pair mass $m_{\nu\nu}$ 
in $\tau^-_{L,R}\to \ell \: 3\nu$ decays (obtained from Eq. \eqref{eq:lepDecay})}
\label{fig:2DCorrLep}
\end{figure}

\subsubsection{Hadronic tau decays} $\;$\\
\\
It is important to distinguish individual hadronic tau decay modes.
We consider the cases:
\begin{itemize}
 \item $\tau^- \to \pi^- \:  \nu_{\tau}$ (${\rm BR}=11.6\%$),
 \item $\tau^- \to \pi^-\pi^0 \: \nu_{\tau}$ (${\rm BR}=26\%$), 
   in which the decay proceeds via an intermediate $\rho(770)$--meson resonance,
 \item $\tau^- \to \pi^-\pi^+\pi^- \:  \nu_{\tau}$ or $\pi^-\pi^0\pi^0 \: \nu_{\tau}$ (${\rm BR}=19.3\%$), 
   in which the $3\pi$ system originates from the decay chain $\tau \to a_1(1240) \: \nu_{\tau} \to \rho(\pi\pi) \: \pi \: \nu_{\tau}$. 
\end{itemize}
These decay modes account for the majority of hadronic tau decays.
Other decay channels are neglected in the present version of SVfit.

The likelihood functions described in the following assume that the true decay mode of a tau is known.
An experimental complication arises from the fact that the tau decay modes may get misreconstructed.
The correlation between reconstructed and true decay mode is accounted for in the likelihood model by the ``transfer matrix'' $M$:
\begin{displaymath}
\vec{v}^{rec} = M \cdot \vec{v}^{true} \Leftrightarrow \vec{v}^{true} = M^{-1} \cdot \vec{v}^{rec}.
\end{displaymath}
The components $M^{-1}_{ij}$ of the inverse of the transfer matrix represent the probability
that the true tau decay mode of a reconstructed tau is $i$,
given that the reconstructed decay mode is $j$.
The matrix $M$ is taken from the Monte Carlo simulation~\footnote{
  Good agreement between data and simulation has been observed in the distribution of decay modes 
  reconstructed (by the HPS tau identification algorithm) 
  in $Z/\gamma^{*} \rightarrow \tau \tau \rightarrow \mu \tau_{had}$ candidate events~\cite{TAU-11-001}.
}.

\subparagraph{$\tau^-\to \pi^- \: \nu_{\tau}$ decays} $\;$\\
\\
The fifferential decay width for the decay of a tau lepton to single charged pion plus neutrino is given by~\cite{TauPol1}:
\begin{equation}
\frac{d\Gamma}{d\overline x d\overline\phi} = \frac{1}{2\pi}\left(1 + P_{\tau}(2x-1)\right)
\label{eq:hadDecay}
\end{equation}
for tau leptons of polarization $P_{\tau}=+1$ and $P_{\tau}=-1$.
The unpolarized case is obtained by setting $P_{\tau}=0$.

\subparagraph{$\tau^- \to \to \rho^{-} \nu_{\tau} \to \pi^-\pi^0 \: \nu_{\tau}$ decays} $\;$\\
\\
The decay width for the decay to charged and neutral pion plus neutrino,
$\tau^- \to \to \rho^{-} \nu_{\tau} \to \pi^-\pi^0 \: \nu_{\tau}$,
is taken from~\cite{TauPol1}.
We consider the two stages of the decay, $\tau^- \to \to \rho^{-} \nu_{\tau}$ and $\rho^{-} \to \pi^-\pi^0$,
separately.

The differential decay width for the decay $\tau^- \to \to \rho^{-} \nu_{\tau}$ is computed separately
for decays to $\rho$--mesons of transverse (T) and longitudinal (L) polarization:
\begin{eqnarray}
H_{v}^{T} & = & \mbox{LORENZO} \nonumber \\
H_{v}^{L} & = & \mbox{LORENZO} 
\label{eq:tauToRhoDecayWidth}
\end{eqnarray}
The finite width of the $\rho$--meson is accounted for by integration of Eq.~\ref{eq:tauToRhoDecayWidth}
over the vector meson resonance shape, $F_{v}(m^{2})$, following Ref.~\cite{TauPol1}:
\begin{equation}
\frac{d\Gamma}{\overline{x}} \propto \int_{2m_{\pi}^{2}}^{xm_{\tau}^{2}} F_{v}(m^{2}) H_{v}^{\alpha} \, \mathrm{d} m^{2}, \mbox{LORENZO}
\label{eq:vectorMesonLineShapeIntegral}
\end{equation}
with $\alpha=T,L$.
The vector meson resonance shape is given by:
\begin{equation}
F_{v}(m^{2}) = \frac{\left( 1 - \frac{m^{2}}{m_{\tau}^{2}} \right) \left( 1 + \frac{2m^{2}}{m_{\tau}^{2}} \right) f_{\rho}}{\vert m^{2} - m_{v}^{2} + im\Gamma_{v}(m^{2}) \vert^{2}} \mbox{LORENZO}
\label{eq:vectorMesonResonanceShape}
\end{equation}
and depends on,
\begin{equation}
f_{\rho} = \left( 1 - \frac{4m_{\pi}^{2}}{m^{2}} \right)^{\frac{3}{2}}, \mbox{LORENZO}
\label{eq:rhoMesonLineShapeFactor}
\end{equation}
the $\rho$--meson line--shape factor.
The vector meson line shape integral of Eq.~\ref{eq:vectorMesonLineShapeIntegral} is computed by numerical integration.

\begin{figure}[htbp]
\centering
\subfigure[]{
  \includegraphics[width=0.45\linewidth]{figures/MassReconstruction/hRhoTMinus.pdf}
  \label{fig:hRhoTMinus}
}
\subfigure[]{
  \includegraphics[width=0.45\linewidth]{figures/MassReconstruction/hRhoTPlus.pdf}
  \label{fig:hRhoTPlus}
} \\
\subfigure[]{
  \includegraphics[width=0.45\linewidth]{figures/MassReconstruction/hRhoLMinus.pdf}
  \label{fig:hRhoLMinus}
}
\subfigure[]{
  \includegraphics[width=0.45\linewidth]{figures/MassReconstruction/hRhoLPlus.pdf}
  \label{fig:hRhoLPlus}
} \\
\caption{
  Probability density function for the decay $\tau_{l}^{-} \to \rho_{\alpha}^{-} \nu_{\tau}$.
  The label $l$ represents the helicity state of the tau lepton ($l=R$ for $P_{\tau}=+1$, $l=L$ for $P_{\tau}=-1$),
  the label $\alpha$ indicates the polarization of the $\rho$--meson ($\alpha=T$ for transverse, $\alpha=T$ for longitudinal polarization).
  The functions have been obtained by numerical integration of Eq.~\ref{eq:vectorMesonLineShapeIntegral},
  using Eq.~\ref{eq:rhoMesonLineShapeFactor} for the $\rho$--meson line--shape factor.
}
\label{fig:hVectors}
\end{figure}

We parametrize the decay widths for the second stage of the decay, $\rho^{-} \to \pi^-\pi^0$, 
as function of the fraction $\overline{z} = \frac{\overline{E}_{\pi}}{\overline{E}_{vis}}$ of $\rho$--meson energy carried by the charged pion.
The conditional probability density function $\frac{d\Gamma(\overline x|\overline z)}{d\overline x d\overline\phi}$,
given a measured value of $\overline z$, is given by:
\begin{equation} 
\frac{d\Gamma}{d \overline x d \overline \phi}(\overline x|\overline z) 
= \frac{1}{2\pi}\frac{\frac{d\Gamma_L}{d\overline x}(\overline x) \cdot \frac{d\Gamma(\rho^-_L)}{d\overline z} + \frac{d\Gamma_T}{d \overline x}(\overline x) \cdot \frac{d\Gamma(\rho^-_T)}{d\overline z}}
{M_L \frac{d\Gamma(\rho^-_L)}{d\overline z} + M_T \frac{d\Gamma(\rho^-_T)}{d\overline z}}
\label{eq:rhoCondZ}
\end{equation}
where $M_{\alpha}=\int_{0}^{1}\frac{d\Gamma_{\alpha}}{d\overline x}(\overline x)d\overline x$ 
and $\alpha=T$ ($\alpha=L$) for decays of transversely (longitudinally) polarized $\rho$--mesons.
The factors $\frac{d\Gamma(\rho^-_T)}{d\overline z}$ and $\frac{d\Gamma(\rho^-_L)}{d\overline z}$ are take from Ref.~\cite{TauPol1}:
\begin{eqnarray} 
\frac{d\Gamma(\rho^-_L)}{d\overline z} & = & 3(2\overline z-1)^2 \nonumber \\
\frac{d\Gamma(\rho^-_T)}{d\overline z} & = & 6\overline z(1-\overline z). \\
\label{eq:dZrho}
\end{eqnarray}
The conditional probability density functions of Eq.~\ref{eq:rhoCondZ} are visualized
separarely for the two tau polarization states in Fig.~\ref{fig:2DCorrRho}.

\begin{figure}[htbp]
\centering
\subfigure[]{
  \includegraphics[width=0.45\linewidth]{figures/MassReconstruction/2DCorrRhoMinus.pdf}
  \label{fig:2DCorrRhoMinus}
}
\subfigure[]{
  \includegraphics[width=0.45\linewidth]{figures/MassReconstruction/2DCorrRhoPlus.pdf}
  \label{fig:2DCorrRhoPlus}
} \\
\caption{
  Conditional probability density $\frac{d\Gamma}{d\overline{x}}$ (Eq.~\ref{eq:rhoCondZ}) 
  for a tau lepton to decay to a $\rho$--meson carrying energy fraction $\overline{x}$
  for different values $\overline{z}$ of the fraction of $\rho$--meson energy carried by the charged pion.
}
\label{fig:2DCorrRho}
\end{figure}

\subparagraph{$\tau^- \to a_{1}^{-} \nu_{\tau} \to \pi^{-}\pi^{+}\pi^{-} \: \nu_{\tau}$ and $\tau^- \to a_{1}^{-} \nu_{\tau} \to \pi^{-}\pi^{0}\pi^{0} \: \nu_{\tau}$ decays} $\;$\\
\\
The differential decay width for tau lepton decays to three pions
are computed in two stages,
for $\tau^- \to a_{1}^{-} \nu_{\tau}$ and $a_{1}^{-} \to \pi^{-}\pi^{+}\pi^{-}$ ($a_{1} \to \pi^{-}\pi^{0}\pi^{0}$).

The computation of the first stage, $\tau^- \to a_{1}^{-} \nu_{\tau}$,
is similar to the case of $\tau^- \to \rho^{-} \nu_{\tau}$ decays.
The main difference is that a different meson line shape factor is used in Eq.~\ref{eq:vectorMesonResonanceShape}
and the lower bound of the integral in Eq.~\ref{eq:vectorMesonLineShapeIntegral} amounts to $3m_{\pi}$ in case of $\tau^- \to a_{1}^{-} \nu_{\tau}$ decays.
We use the parametrization given in Ref.~\cite{Kuhn:1990ad}
for the line--shape factor of the $a_{1}$ meson:
\begin{equation}
f_{a_{1}} = \mbox{LORENZO}
\label{eq:a1MesonLineShapeFactor}
\end{equation}
The decay widths are computed separately for longitudinal and transverse polarization of the $a_{1}$--meson.
The results are reported in Fig.~\ref{fig:hVectors2}.

\begin{figure}[htbp]
\centering
\subfigure[]{
  \includegraphics[width=0.45\linewidth]{figures/MassReconstruction/hA1TMinus.pdf}
  \label{fig:hA1TMinus}
}
\subfigure[]{
  \includegraphics[width=0.45\linewidth]{figures/MassReconstruction/hA1TPlus.pdf}
  \label{fig:hA1TPlus}
} \\
\subfigure[]{
  \includegraphics[width=0.45\linewidth]{figures/MassReconstruction/hA1LMinus.pdf}
  \label{fig:hA1LMinus}
}
\subfigure[]{
  \includegraphics[width=0.45\linewidth]{figures/MassReconstruction/hA1LPlus.pdf}
  \label{fig:hA1LPlus}
} \\
\caption{
  Probability density function for the decay $\tau_{l}^{-} \to a_{{1}_{\alpha}} \nu_{\tau}$.
  The label $l$ represents the helicity state of the tau lepton ($l=R$ for $P_{\tau}=+1$, $l=L$ for $P_{\tau}=-1$),
  the label $\alpha$ indicates the polarization of the $a_{1}$--meson ($\alpha=T$ for transverse, $\alpha=T$ for longitudinal polarization).
  The functions have been obtained by numerical integration of Eq.~\ref{eq:vectorMesonLineShapeIntegral},
  using Eq.~\ref{eq:a1MesonLineShapeFactor} for the line--shape factor of the $a_{1}$--meson.
}
\label{fig:hVectors2}
\end{figure}

We define $\overline z$ to be the fraction of $a_{1}$--meson energy carried by the ``distinguishable'' pion, 
which we define to be the charged pion (pion of charge opposite to the tau lepton charge) in case of $\tau^- \to a_{1}^{-} \nu_{\tau} \to \pi^{-}\pi^{+}\pi^{-} \: \nu_{\tau}$
($\tau^- \to a_{1}^{-} \nu_{\tau} \to \pi^{-}\pi^{0}\pi^{0} \: \nu_{\tau}$) decays.
The conditional probability density function $\frac{d\Gamma(\overline x|\overline z)}{d\overline x d\overline\phi}$
given a measured value of $\overline z$ are given by:
\begin{equation} 
\frac{d\Gamma}{d \overline x d \overline \phi}(\overline x|\overline z) 
= \frac{1}{2\pi}\frac{\frac{d\Gamma_L}{d\overline x}(\overline x) \cdot \frac{d\Gamma(a^-_{1\:L})}{d\overline z} + \frac{d\Gamma_T}{d \overline x}(\overline x) \cdot \frac{d\Gamma(a^-_{T\: 1})}{d\overline z}}
{M_L \frac{d\Gamma(a^-_{1\:L})}{d\overline z} + M_T \frac{d\Gamma(a^-_{1\: T})}{d\overline z}}.
\label{eq:a1CondZ}
\end{equation}
The factors $\frac{d\Gamma(a^{-}_{1\: T})}{d\overline z}$ and $\frac{d\Gamma(a^{-}_{1\: L})}{d\overline{z}}$ are taken from Ref.~\cite{TauPol2}:
\begin{equation}
\mbox{LORENZO}
\label{eq:dZa1}
\end{equation}
The integrals are evaluated numerically.
The resulting conditional probability density functions are shown in Fig.~\ref{fig:hzA1},
separatelty for decays of left--handed and right--handed tau leptons.

\begin{figure}[htbp]
\centering
\subfigure[]{
  \includegraphics[width=0.45\linewidth]{figures/MassReconstruction/hzA1L.pdf}
  \label{fig:hZA1L}
}
\subfigure[]{
  \includegraphics[width=0.45\linewidth]{figures/MassReconstruction/hzA1T.pdf}
  \label{fig:hZA1T}
} \\
\caption{
  Probability density function (Eq.~\ref{eq:a1CondZ}) for the ``distinguishable'' pion produced in the decays
  $\tau^- \to a_{1}^{-} \nu_{\tau} \to \pi^{-}\pi^{+}\pi^{-} \: \nu_{\tau}$ and $\tau^- \to a_{1}^{-} \nu_{\tau} \to \pi^{-}\pi^{0}\pi^{0} \: \nu_{\tau}$ 
  of longitudinally (left) and transversely (right) polarized $a_{1}$--mesons
  to carry energy fraction $\overline{z}$.
}
\label{fig:hzA1}
\end{figure}

Using the numerical values for $\frac{d\Gamma(a^-_{1\:T})}{d\overline z}$ and $\frac{d\Gamma(\rho^-_{\: L})}{d\overline z}$,
the conditional probability density functions for the $\tau^- \to \pi^-\pi^0\pi^0 \: \nu_{\tau}$ and $\tau^- \to \pi^-\pi^+\pi^- \:  \nu_{\tau}$ 
decays are shown in Fig. \ref{fig:2DCorrA1}, separately for the two tau polarization states.

\begin{figure}[htbp]
\centering
\subfigure[]{
  \includegraphics[width=0.45\linewidth]{figures/MassReconstruction/2DCorrA1Minus.pdf}
  \label{fig:2DCorrA1Minus}
}
\subfigure[]{
  \includegraphics[width=0.45\linewidth]{figures/MassReconstruction/2DCorrA1Plus.pdf}
  \label{fig:2DCorrA1Plus}
} \\
\caption{
  Conditional probability density $\frac{d\Gamma}{d\overline{x}}$ (Eq.~\ref{eq:a1CondZ}) 
  for a tau lepton to decay to a $a_{1}$--meson carrying energy fraction $\overline{x}$
  for different values $\overline{z}$ of the fraction of $a_{1}$--meson energy carried by the ``distinguishable'' pion.
}
\label{fig:2DCorrA1}
\end{figure}


\subsection{Missing $E_{T}$}
\label{sec:likelihoods_met}

The \MET likelihood quantifies the compatibility of a tau decay hypothesis
with the missing transverse momentum reconstructed in an event.
Assuming that the neutrinos produced in tau decays are the only source of \MET,
momentum conservation in the plane perpendicular to the beam axis implies that
the vectorial sum of neutrino momenta matches the reconstructed \MET~\footnote{
  Energy and momentum conservation in longitudinal direction cannot be used to constrain the momenta
  of the neutrinos produced in tau decays, as remnants of the colliding protons
  carry away an unknown amount of energy and longitudinal momentum.
}:
\begin{eqnarray}
\sum p_{x}^{\nu} & = & \METx = -\sum p_{x}^{rec} \\
\sum p_{y}^{\nu} & = & \METy = -\sum p_{y}^{rec}.
\label{eq:met_balance}
\end{eqnarray}
The sums on the right extend over all particles reconstructed by the particle--flow (PF) algorithm~\cite{PFT-09-001}.

Differences between $\sum p_{x}^{\nu}$ and $\METx$ ($\sum p_{y}^{\nu}$ and $\METy$) 
may arise due to resolution effects and are accounted for in the probability model, assuming a Gaussian resolution.
The \MET likelihood is computed based on the residual between the sum of neutrino momenta
for a given tau decay hypothesis and the value of \MET in the event, reconstructed using the PF algorithm:
\begin{equation}
p_{\MET} = \frac{1}{2 \pi \sqrt{\vert V \vert}} 
\cdot \exp \left( -\frac{1}{2}
 \left( \begin{array}{c} \mbox{\METx} - \sum p_{x}^{\nu} \\ \mbox{\METy} - \sum p_{y}^{\nu} \end{array} \right)^{T}
\cdot V^{-1} \cdot
 \left( \begin{array}{c} \mbox{\METx} - \sum p_{x}^{\nu} \\ \mbox{\METy} - \sum p_{y}^{\nu} \end{array} \right)
\right),
\end{equation}
where $\vert V \vert$ denotes the determinant of $V$.
The expected resolution of the \MET reconstruction is represented by the covariance matrix $V$ 
and is estimated on an event--by--event basis using the \MET--significance algorithm~\cite{Chatrchyan:2011tn}.
%Typical resolutions on the two components \METx and \METy 
%in the 2011/2012 data--taking period are $\sigma\METx = \sigma\METy \sim 15$~GeV~\cite{DP_12_003,DP_12_013}.

\subsection{Full likelihood}

Modulo an overall and irrelevant multiplicative constant, the full SVfit likelihood is given by:
\begin{equation} \label{eq:SVfit}
\begin{split}
p(\vec{x} | \vec{y}, \vec{a}) \propto & \sum_{i,j} \sum_{\alpha = L,R}\sum_{\beta = L,R}\gamma_{\alpha \beta}
\frac{d\Gamma_{i}^{\alpha}( \vec{x}_{-} | \vec{y}_{-}, \vec{a}_{i})}{d\vec{x}_{i} }
\frac{d\Gamma_{j}^{\beta} ( \vec{x}_{+} | \vec{y}_{+}, \vec{a}_{j})}{d\vec{x}_{j} } 
M_{i+}^{-1} v_{+}^{rec} M_{j-}^{-1} v_{-}^{rec} \\
  & \times  \; \mbox{exp}
\left\{
-\frac{1}{2}
\left(
 \left( \begin{array}{c} \mbox{\METx} - \sum p_{x}^{\nu} \\ \mbox{\METy} - \sum p_{y}^{\nu} \end{array} \right)^{T}
\cdot V^{-1} \cdot
 \left( \begin{array}{c} \mbox{\METx} - \sum p_{x}^{\nu} \\ \mbox{\METy} - \sum p_{y}^{\nu} \end{array} \right)
\right)
\right\}
\end{split}
\end{equation}

Uniform probability density functions for the $\overline \phi$ angles have been assumed: $d\Gamma/d\overline \phi = 1/2\pi$.
The functions $\frac{d\Gamma^{\alpha}( \vec{x} | \vec{y}, \hat{a})}{d\vec{x}}$
are proportional to the decay widths described in sections~\ref{sec:psKine} and~\ref{sec:meKine},
namely Eq.~\ref{eq:hadDecayPS} and \eqref{eq:leptDecayPS} for the phase--space model,
and Eq.~\ref{eq:lepDecay},~\ref{eq:rhoCondZ} and~\ref{eq:a1CondZ} for the
matrix element model.
